[Вернуться][main]

---

# Выполнение скользящего обновления

## Цели

- Выполни скользящее обновление с помощью kubectl.

## Обновление приложения

Пользователи ожидают, что приложения будут доступны постоянно, а разработчики должны развертывать их новые версии
несколько раз в день. В Kubernetes это делается с помощью скользящих обновлений. Скользящее обновление позволяет
проводить обновление развертывания с нулевым временем простоя. Это происходит путем постепенной замены текущих модулей
новыми. Новые модули планируются на узлах с доступными ресурсами, и Kubernetes ждет, пока эти новые модули запустятся,
прежде чем удалить старые модули.

В предыдущем блоке мы масштабировали приложение для запуска нескольких экземпляров. Это необходимо для выполнения
обновлений без ущерба для доступности приложения. По умолчанию максимальное количество подов, которые могут быть
недоступны во время обновления, и максимальное количество новых подов, которые могут быть созданы, равно единице. Оба
параметра могут быть настроены как в виде чисел, так и в виде процентов (от числа подов). В Kubernetes обновления
версионированы, и любое обновление развёртывания можно откатить к предыдущей (стабильной) версии.

### Визуализация скользящих обновлений

![](https://kubernetes.io/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates3.svg)

Аналогично масштабированию приложений, если развёртывание опубликовано, сервис будет балансировать нагрузку только на
доступные поды во время обновления. Доступный Pod - это экземпляр, который доступен пользователям приложения.

Скользящие обновления позволяют выполнять следующие действия:

- перемещать приложение из одной среды в другую (через обновление образа контейнера)
- откат к предыдущим версиям
- непрерывная интеграция и непрерывная доставка приложений (CI/CD) с нулевым временем простоя.

> Если деплоймент открыт публично, то во время обновления сервис будет балансировать нагрузку только на доступные поды.

## Обновление версии приложения

Чтобы получить список развёртываний, выполни подкоманду get deployments:

```sh
kubectl get deployments
```

Чтобы получить список запущенных подов, выполни подкоманду get pods:

```sh
kubectl get pods
```

Чтобы посмотреть текущую версию образа приложения, выполни подкоманду describe pods и найдите поле Image:

```sh
kubectl describe pods
```

Чтобы обновить образ приложения до версии 2, используй подкоманду set image, после чего укажи имя развёртывания и
новую версию образа:

```sh
kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2
```

Эта команда уведомила деплоймент об использовании другого образа для приложения и инициировала скользящее
обновление. Проверь статус новых подов и посмотри, как завершается старый, с помощью подкоманды get pods:

```sh
kubectl get pods
```

## Проверка обновления

Сначала проверь, запущено ли приложение. Чтобы узнать открытый IP-адрес и порт, выполни команду describe service:

```sh
kubectl describe services/kubernetes-bootcamp
```

Создай переменную окружения NODE_PORT со значением порта узла:

```sh
export NODE_PORT="$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')".
echo "NODE_PORT=$NODE_PORT"
```

Далее выполни curl к открытому IP и порту:

```sh
curl http://"$(minikube ip):$NODE_PORT"
```

Каждый раз, когда будешь выполнять команду curl, будешь попадать в разные поды. Обрати внимание, что все поды
теперь работают с последней версией (v2).

Также можно подтвердить обновление, выполнив подкоманду rollout status:

```sh
kubectl rollout status deployments/kubernetes-bootcamp
```

Чтобы посмотреть текущую версию образа приложения, выполни подкоманду describe pods:

```sh
kubectl describe pods
```

В поле Image выходных данных убедись, что запущена последняя версия образа (v2).

## Откат обновления

Выполним ещё одно обновление и попробуем развернуть образ с меткой v10:

```sh
kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=gcr.io/google-samples/kubernetes-bootcamp:v10
```

Используй get deployments, чтобы узнать статус развертывания:

```sh
kubectl get deployments
```

Обрати внимание, что в выводе не указано нужное количество доступных подов. Выполните подкоманду get pods, чтобы
увидеть все Pods:

```sh
kubectl get pods
```

Обрати внимание, что некоторые из Pods имеют статус ImagePullBackOff.

Чтобы разобраться в проблеме, выполни подкоманду describe pods:

```sh
kubectl describe pods
```

В разделе Events выходных данных для затронутых подсистем обрати внимание, что версия образа v10 не существует в
репозитории.

Чтобы откатить развёртывание к последней рабочей версии, воспользуйся подкомандой rollout undo:

```sh
kubectl rollout undo deployments/kubernetes-bootcamp
```

Команда rollout undo возвращает развёртывание к предыдущему известному состоянию (v2 образа). Обновления не имеют
версий, и поэтому есть возможность вернуться к любому ранее известному состоянию развёртывания.

Используй подкоманду get pods, чтобы снова получить список подов:

```sh
kubectl get pods
```

Работают четыре пода. Чтобы проверить образ, развёрнутый на этих подах, используй подкоманду describe pods:

```sh
kubectl describe pods
```

Развёртывание снова использует стабильную версию приложения (v2). Откат прошел успешно.

Не забудь очистить локальный кластер

```sh
kubectl delete deployments/kubernetes-bootcamp services/kubernetes-bootcamp
```

---

[Вернуться][main]


[main]: ../../README.md "содержание"
