[Вернуться][main]

---

# Запуск нескольких экземпляров (Instances) приложения

## Цели

- Узнай, что такое сервис в Kubernetes
- Пойми, как метки и селекторы связаны с сервисом
- Выведи приложения за пределы кластера Kubernetes с помощью сервиса

## Масштабирование приложения

Ранее ты создал развёртывание, а затем открыл его для публичного доступа через сервис. Развёртывание создало только
один Pod для запуска приложения. Когда трафик увеличится, тебе понадобится масштабировать приложение, чтобы оно
соответствовало запросам пользователей.

Масштабирование осуществляется путем изменения количества реплик в развертывании.

> Ты можешь с самого начала создать развёртывание с несколькими экземплярами, используя параметр --replicas для
> команды kubectl create deployment

> Примечание:
> Если ты пытаешься сделать это после предыдущего блока, возможно, ты удалил сервис, открывающую развёртывание. В этом
> случае снова открой развертывание с помощью команды:
> ```sh
> kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
> ```

### Визуализация масштабирования

![scale](https://kubernetes.io/docs/tutorials/kubernetes-basics/public/images/module_05_scaling1.svg)

> Масштабирование осуществляется путем изменения количества реплик в развёртывании.

Масштабирование развёртывания обеспечит создание новых подов и их планирование на узлах с доступными ресурсами.
Масштабирование увеличит количество подов до нового желаемого состояния. Kubernetes также поддерживает
автомасштабирование подов, но это выходит за рамки данного семинара. Масштабирование до нуля также возможно, и это
приведет к прекращению работы всех подов указанного развёртывания.

Запуск нескольких экземпляров приложения потребует способа распределения трафика между ними. Сервисы имеют встроенный
балансировщик нагрузки, который будет распределять сетевой трафик между всеми подсистемами указанного развёртывания.
Сервисы будут постоянно отслеживать работающие поды с помощью конечных точек, чтобы убедиться, что трафик
отправляется только на доступные поды.

Когда у нас будет несколько экземпляров приложения, мы сможем выполнять обновления без простоев.
Теперь перейдём в терминал и изменим масштаб нашего приложения.

## Масштабирование развёртывания

Чтобы получить список развертываний, используй подкоманду get deployments:

```sh
kubectl get deployments
```

Вывод будет примерно таким:

```sh
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
kubernetes-bootcamp   1/1     1            1           43s
```

У нас должен быть 1 под. Если нет, выполни команду ещё раз. Вывод отображает:

- **NAME** имена развёртываний в кластере.
- **READY** соотношение текущих/необходимых реплик.
- **UP-TO-DATE** количество реплик, которые были обновлены для достижения желаемого состояния.
- **AVAILABLE** сколько реплик приложения доступно вашим пользователям.
- **AGE** количество времени, в течение которого приложение работает.

Чтобы увидеть набор реплик, созданный развёртыванием, выполните команду:

```sh
kubectl get rs
```

Обратите внимание, что имя ReplicaSet всегда имеет формат `[DEPLOYMENT-NAME]-[RANDOM-STRING]`. Случайная строка
генерируется случайным образом и использует pod-template-hash в качестве затравки.

В этом выводе есть два важных столбца:

- **DESIRED** отображает желаемое количество реплик приложения, которое вы задаете при создании развертывания.
  Это желаемое состояние.
- **CURRENT** показывает, сколько реплик запущено в данный момент.

Далее давай масштабируем развёртывание до 4 реплик. Используй команду kubectl scale, затем укажи тип развертывания,
имя и желаемое количество экземпляров:

```sh
kubectl scale deployments/kubernetes-bootcamp --replicas=4
```

Чтобы снова получить список развертываний, воспользуйтесь командой get deployments:

```sh
kubectl get deployments
```

Изменение было применено, и у нас есть 4 экземпляра приложения. Далее проверим, изменилось ли количество подов:

```sh
kubectl get pods -o wide
```

Теперь есть 4 пода, с разными IP-адресами. Это изменение было зарегистрировано в логе событий развёртывания.
Чтобы проверить это, используй подкоманду describe:

```sh
kubectl describe deployments/kubernetes-bootcamp
```

В выводе этой команды ты также можешь увидеть, что теперь существует 4 реплики.

## Балансировка нагрузки

Давай проверим, что сервис балансирует нагрузку на трафик. Чтобы узнать открытые IP и порт, мы можем использовать
сервис describe, как мы узнали в предыдущей части семинара:

```sh
kubectl describe services/kubernetes-bootcamp
```

Создай переменную окружения NODE_PORT, которая будет содержать значение порта узла:

```sh
export NODE_PORT="$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')"
echo NODE_PORT=$NODE_PORT
```

Далее выполни curl к открытому IP-адресу и порту. Выполни команду несколько раз:

```sh
curl http://"$(minikube ip):$NODE_PORT"
```

При каждом запросе мы получаем разный Pod. Это демонстрирует, что балансировка нагрузки работает.

> Примечание:
> Если используешь minikube с Docker Desktop в качестве драйвера контейнера, туннель minikube необходим.
> Это связано с тем, что контейнеры внутри Docker Desktop изолированы от вашего хост-компьютера.
>
> В отдельном окне терминала выполните:
> ```sh
> minikube service kubernetes-bootcamp --url
> ```
> Вывод будет примерно таким:
> ```sh
> http://127.0.0.1:52438
> !  Because you are using a Docker driver on darwin, the terminal needs to be open to run it.
> ```
>
> Затем используй указанный URL для доступа к приложению:
> ```sh
> curl 127.0.0.1:52438
> ```

## Уменьшение масштаба

Чтобы уменьшить масштаб развёртывания до 2 реплик, выполни подкоманду scale:

```sh
kubectl scale deployments/kubernetes-bootcamp --replicas=2
```

Выведи список развёртываний, чтобы проверить, было ли применено изменение, с помощью подкоманды get deployments:

```sh
kubectl get deployments
```

Количество реплик уменьшилось до двух. Просмотри количество подов, используя команду get pods:

```sh
kubectl get pods -o wide
```

Из вывода видим, что два пода было удалено.

---

[Вернуться][main]


[main]: ../../README.md "содержание"
